<html>
<head>
<style>
  ul {
    list-style-type: none;
    list-style-position: inside;
    margin: 0;
    padding: 10px 10px 5px;
  }
  div.scroll_list {
    width: 100%;
    height: 45%;
    overflow: auto;
    border:2px solid;
    border-radius:5px;
    border-color: gainsboro;
  }
  div#if {
    width: 100%;
  }
  table {
    width: 100%;
    height: 35%;
  }
  canvas#viewport{
    border:2px solid;
    border-radius:5px;
    border-color: gainsboro;
  }
  h3, h4 {
    margin-bottom: 0;
  }
</style>
<script src="js/jquery.min.js"></script>
<script src="js/arbor.js"></script>
<script src="js/graph.js"></script>
<script type="text/javascript">
var ws;
var sys;
var canvas;
var last_range;

function appendMsg(ws_logs, msg) {
  ws_logs.append('<li>' + msg + '</li>');
  var scroll_div = ws_logs.parent()[0];
  scroll_div.scrollTop = scroll_div.scrollHeight;
}

function bindOps(ws_logs) {
  $('#insert').unbind();
  $('#find').unbind();
  $('#delete').unbind();
  $('#range').unbind();

  $('#insert').click(function() {
    var i,j,w;
    i = $('#insert_i').val();
    j = $('#insert_j').val();
    w = $('#insert_w').val();
    if (i && j && w && ws.readyState == WebSocket.OPEN) {
      var msg  = "INSERT,"+i+","+j+","+w;
      ws.send(msg);
    } else if (ws.readyState == WebSocket.OPEN) {
      appendMsg(ws_logs, "Missing argument(s)");
    } else {
      appendMsg(ws_logs, "WebSocket connection error");
    }
  });
  $('#delete').click(function() {
    var i,j;
    i = $('#delete_i').val();
    j = $('#delete_j').val();
    if (i && j && ws.readyState == WebSocket.OPEN) {
      var msg  = "DELETE,"+i+","+j;
      ws.send(msg);
    } else if (ws.readyState == WebSocket.OPEN) {
      appendMsg(ws_logs, "Missing argument(s)");
    } else {
      appendMsg(ws_logs, "WebSocket connection error");
    }
  });
  $('#find').click(function() {
    var i,j;
    i = $('#find_i').val();
    j = $('#find_j').val();
    if (i && j && ws.readyState == WebSocket.OPEN) {
      var msg  = "FIND,"+i+","+j;
      ws.send(msg);
    } else if (ws.readyState == WebSocket.OPEN) {
      appendMsg(ws_logs, "Missing argument(s)");
    } else {
      appendMsg(ws_logs, "WebSocket connection error");
    }
  });
  $('#range').click(function() {
    var i1,j1,i2,j2;
    i1 = $('#range_i1').val();
    j1 = $('#range_j1').val();
    i2 = $('#range_i2').val();
    j2 = $('#range_j2').val();
    if (i1 && j1 && j2 && j2 && ws.readyState == WebSocket.OPEN) {
      var msg  = "RANGE,"+i1+","+j1+","+i2+","+j2;
      ws.send(msg);
    } else if (ws.readyState == WebSocket.OPEN) {
      appendMsg(ws_logs, "Missing argument(s)");
    } else {
      appendMsg(ws_logs, "WebSocket connection error");
    }
  });

  $('#close').click(function() {
    ws.close();
    $('#if').hide();
    $('#start_ws').show();
  });
}

function sendDeltaTimeOp(list, ws_logs) {
  if (list.length) {
    var entry = list.pop();
    window.setTimeout(function() {
      if (ws.readyState == WebSocket.OPEN) {
        ws.send(entry.op);
        sendDeltaTimeOp(list);
      } else {
        appendMsg(ws_logs, "WebSocket connection error");
      }
    }, entry.delta);
  }
}

function bindSendMessage(ws_logs) {
  $('#send').unbind();

  $('#send').click(function() {
    var message = $('#message').val();
    if (message && ws.readyState == WebSocket.OPEN) {
      ws.send(message);
    } else if (ws.readyState == WebSocket.OPEN) {
      appendMsg(ws_logs, "Missing argument(s)");
    } else {
      appendMsg(ws_logs, "WebSocket connection error");
    }
  });
}

function bindUseName(ws_logs) {
  $('#use_name').unbind();

  $('#use_name').change(function() {
    if (ws.readyState == WebSocket.OPEN) {
      sys.eachNode(function(node, pt) {
        if (!('alt' in node)) {
          ws.send("NAME_LOOKUP," + node.name);
        }
      });
    } else {
      appendMsg(ws_logs, "WebSocket connection error");
    }
  });
}

function bindLoadNameMap(ws_logs) {
  $('#name_map').unbind();

  $('#name_map').change(function(evt) {
    var f = evt.target.files[0];
    var reader = new FileReader();
    reader.onload = function(prog) {
      var content = prog.target.result;
      var entries = content.split("\n");
      if (ws.readyState == WebSocket.OPEN) {
        $.each(entries, function(idx, entry) {
          ws.send(entry);
        });
      } else {
        appendMsg(ws_logs, "WebSocket connection error");
      }
    };
    reader.readAsText(f);
    evt.preventDefault();
  });
}

function resizeCanvas() {
  var ops_div = $('#operations')[0];
  canvas.width = ops_div.offsetWidth;
  canvas.height = ops_div.offsetHeight;
  sys.screenSize(canvas.width, canvas.height);
}

function bindLoadgraph(ws_logs) {
  $('#load_graph').unbind();

  $('#load_graph').change(function(evt) {
    var f = evt.target.files[0];
    var reader = new FileReader();
    reader.onload = function(prog) {
      var content = prog.target.result;
      var ops = content.split("\n");
      var i;
      var delta_list = [];
      for (i = 0; i < ops.length; i++) {
        var targs = ops[i].trim().split(":",2);
        if (targs.length != 2) {
          console.log("Missing delta time on line " + i + ": " + ops[i]);
          continue;
        }
        var delta = targs[0];
        if (isNaN(parseFloat(delta)) || !isFinite(delta)) {
          console.log("Invalid delta time on line " + i + ": " + ops[i]);
          continue;
        }
        var args = targs[1].trim().split(",");
        if (args.length) {
          var opstr = args[0].toUpperCase();
          var opcode = $.inArray(opstr, ["INSERT", "DELETE", "FIND", "RANGE"])
          var num_args = [4,3,3,5];
          if (opcode > -1 && args.length == num_args[opcode]) {
            delta_list.push({"op":targs[1], "delta":delta})
            continue;
          }
        }
        console.log("Invalid operation on line " + i + ": " + ops[i]);
      }
      console.log(delta_list);
      sendDeltaTimeOp(delta_list.reverse(), ws_logs);
    };
    reader.readAsText(f);
    evt.preventDefault();
  });
}

function wipeGraph() {
  sys.eachNode(function(node, pt) {
    sys.pruneNode(node);
  });
  sys.eachEdge(function(edge, pt1, pt2) {
    sys.pruneEdge(edge);
  });
}

function startWS()
{
  $('#start_ws').hide();
  wipeGraph();

  var ws_logs = $('#ws_logs');
  ws_logs.empty();

  if ("WebSocket" in window) {
    ws = new WebSocket("ws://" + window.location.host + "/sub");

    appendMsg(ws_logs, "Opening WebSocket Connection...");

    ws.onopen = function () {
      appendMsg(ws_logs, "Opened WebSocket Connection.");

      // Show application interface
      $('#if').show();
      resizeCanvas();
      bindOps(ws_logs);
      bindSendMessage(ws_logs);
      bindUseName(ws_logs);
      bindLoadNameMap(ws_logs);
    };

    ws.onmessage = function(event) {
      var msg = event.data;
      try {
        var result = JSON.parse(msg);

        if (result.op == "INSERT" && result.success == 1) {
          if (
            result.i >= last_range.i1 && result.i <= last_range.i2 &&
            result.j >= last_range.j1 && result.j <= last_range.j2
          ) {
            sys.addEdge(result.i, result.j, {weight: result.weight});
          }

        } else if (result.op == "DELETE" && result.success == 1) {
          if (
            result.i >= last_range.i1 && result.i <= last_range.i2 &&
            result.j >= last_range.j1 && result.j <= last_range.j2
          ) {
            var edges = sys.getEdges(result.i, result.j);
            $.each(edges, function(idx, edge) {
              sys.pruneEdge(edge);
              if (sys.getEdgesFrom(edge.source) == 0 && sys.getEdgesTo(edge.source) == 0) {
                sys.pruneNode(edge.source);
              }
              if (sys.getEdgesFrom(edge.target) == 0 && sys.getEdgesTo(edge.target) == 0) {
                sys.pruneNode(edge.target);
              }
            });
          }
        
        } else if (result.op == "RANGE") {
          // Clear graph
          wipeGraph();
          $.each(result.entries, function(idx, entry) {
            sys.addEdge(entry.i, entry.j, {weight: entry.w});
          });
          last_range = {'i1':result.i1, 'i2':result.i2, 'j1':result.j1, 'j2':result.j2};
        } else if (result.op == "NAME_LOOKUP" && result.success == 1) {
          var node = sys.getNode(result.key);
          node.alt = result.value;
        }
      } catch (e) {
      }
      appendMsg(ws_logs, msg);
    };

    ws.onclose = function() {
      appendMsg(ws_logs, "Closed WebSocket Connection");
      $('#if').hide();
      $('#start_ws').show();
    };

  } else {
    appendMsg(ws_logs, "Your browser does not support WebSocket");
  }
}

</script>
</head>

<body>
<h1>WebSocket Graph Server</h1>
<hr>
<div id="ws">
  <button id="start_ws" onclick="startWS()">Start connection</button>

  <div id='if' style="display:none">
  <button id="close">Close connection</button>

  <table>
  <tr>
    <th align="left"><h3>Operations</h3></th>
    <th align="left"><h3>Range Graph</h3></th>
  </tr>
  <tr>
    <td style="width: 50%">
    <div id="operations">
      <h4>Insert Edge</h4>
      <input id="insert_i" type="text" placeholder="Vertex i"/>
      <input id="insert_j" type="text" placeholder="Vertex j"/>
      <input id="insert_w" type="text" placeholder="Weight"/>
      <button id="insert">Insert</button>
    
      <h4>Delete Edge</h4>
      <input id="delete_i" type="text" placeholder="Vertex i"/>
      <input id="delete_j" type="text" placeholder="Vertex j"/>
      <button id="delete">Delete</button>
    
      <h4>Find Edge</h4>
      <input id="find_i" type="text" placeholder="Vertex i"/>
      <input id="find_j" type="text" placeholder="Vertex j"/>
      <button id="find">Find</button>
    
      <h4>Range Find</h4>
      <input id="range_i1" type="text" placeholder="Vertex i lower bound"/> -
      <input id="range_i2" type="text" placeholder="Vertex i upper bound"/><br>
      <input id="range_j1" type="text" placeholder="Vertex j lower bound"/> -
      <input id="range_j2" type="text" placeholder="Vertex j upper bound"/>
      <button id="range">Find</button>
    </div>
    </td>
    <td style="width: 50%">
      <label for="name_map">Upload Name Map</label>
      <input id="name_map" type="file" name="file"/>
      <input id="use_name" type="checkbox"></input>
      <label for="use_name">Use Name</label>
      <input id="show_weight" type="checkbox"></button>
      <label for="show_weight">Show Weight</label>
      <br>
      <canvas id="viewport" width="600" height="300"></canvas>
    </td>
  </tr>
  </table>

  <!--
  <label for="load_graph">Load file</label>
  <input id="load_graph" type="file" name="file"/>
  <br>  
  <label for="message">Message</label>
  <input id="message" type="text"/>
  <input id="send" type="submit" value="Send"/>
  //-->

  <br>
  <div class="scroll_list">
  <ul id="ws_logs">
  </ul>
  </div>
  </div>

</div>
</body>
</html>
