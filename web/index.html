<html>
<head>
<style>
  ul {
    list-style-type: none;
    list-style-position: inside;
    margin: 0;
    padding: 10px 10px 5px;
  }
  div.scroll_list {
    width: 95%;
    height: 50%;
    overflow: auto;
    border:2px solid;
    border-radius:5px;
    border-color: gainsboro;
  }
  div#if {
    width: 100%;
  }
  div.a_third {
    display: inline;
    width: 34%;
  }
  div.a_forth {
    display: inline-block;
    width: 24%;
  }
  div.a_fifth {
    display: inline;
    width: 19%;
  }
  input[type="text"] {
    position: relative;
  }
  h3 {
    margin-bottom: auto;
  }
</style>
<script src="jquery-2.1.0.min.js"></script>
<script type="text/javascript">
var ws;

function appendMsg(ws_logs, msg) {
  ws_logs.append('<li>' + msg + '</li>');
  var scroll_div = ws_logs.parent()[0];
  scroll_div.scrollTop = scroll_div.scrollHeight;
}

function bindOps(ws_logs) {
  $('#insert').unbind();
  $('#find').unbind();
  $('#delete').unbind();
  $('#range').unbind();
  $('#file').unbind();

  $('#insert').click(function() {
    var i,j,w;
    i = $('#insert_i').val();
    j = $('#insert_j').val();
    w = $('#insert_w').val();
    if (i && j && w && ws.readyState == WebSocket.OPEN) {
      var msg  = "INSERT,"+i+","+j+","+w;
      ws.send(msg);
    } else if (ws.readyState == WebSocket.OPEN) {
      appendMsg(ws_logs, "Missing argument(s)");
    } else {
      appendMsg(ws_logs, "WebSocket connection error");
    }
  });
  $('#delete').click(function() {
    var i,j;
    i = $('#delete_i').val();
    j = $('#delete_j').val();
    if (i && j && ws.readyState == WebSocket.OPEN) {
      var msg  = "DELETE,"+i+","+j;
      ws.send(msg);
    } else if (ws.readyState == WebSocket.OPEN) {
      appendMsg(ws_logs, "Missing argument(s)");
    } else {
      appendMsg(ws_logs, "WebSocket connection error");
    }
  });
  $('#find').click(function() {
    var i,j;
    i = $('#find_i').val();
    j = $('#find_j').val();
    if (i && j && ws.readyState == WebSocket.OPEN) {
      var msg  = "FIND,"+i+","+j;
      ws.send(msg);
    } else if (ws.readyState == WebSocket.OPEN) {
      appendMsg(ws_logs, "Missing argument(s)");
    } else {
      appendMsg(ws_logs, "WebSocket connection error");
    }
  });
  $('#range').click(function() {
    var i1,j1,i2,j2;
    i1 = $('#range_i1').val();
    j1 = $('#range_j1').val();
    i2 = $('#range_i2').val();
    j2 = $('#range_j2').val();
    if (i1 && j1 && j2 && j2 && ws.readyState == WebSocket.OPEN) {
      var msg  = "RANGE,"+i1+","+j1+","+i2+","+j2;
      ws.send(msg);
    } else if (ws.readyState == WebSocket.OPEN) {
      appendMsg(ws_logs, "Missing argument(s)");
    } else {
      appendMsg(ws_logs, "WebSocket connection error");
    }
  });

  $('#file').change(function(evt) {
    // console.debug(evt.target.files[0]);
    var f = evt.target.files[0];
    var reader = new FileReader();
    reader.onload = function(prog) {
      var content = prog.target.result;
      var ops = content.split("\n");
      var i;
      var delta_list = [];
      for (i = 0; i < ops.length; i++) {
        var targs = ops[i].trim().split(":",2);
        if (targs.length != 2) {
          console.log("Missing delta time on line " + i + ": " + ops[i]);
          continue;
        }
        var delta = targs[0];
        if (isNaN(parseFloat(delta)) || !isFinite(delta)) {
          console.log("Invalid delta time on line " + i + ": " + ops[i]);
          continue;
        }
        var args = targs[1].trim().split(",");
        if (args.length) {
          var opstr = args[0].toUpperCase();
          var opcode = $.inArray(opstr, ["INSERT", "DELETE", "FIND", "RANGE"])
          var num_args = [4,3,3,5];
          if (opcode > -1 && args.length == num_args[opcode]) {
            delta_list.push({"op":targs[1], "delta":delta})
            continue;
          }
        }
        console.log("Invalid operation on line " + i + ": " + ops[i]);
      }
      console.log(delta_list);
      sendDeltaTimeOp(delta_list.reverse(), ws_logs);
    };
    reader.readAsText(f);
    evt.preventDefault();
  });

  $('#close').click(function() {
    ws.close();
    $('#if').hide();
    $('#start_ws').show();
  });
}

function sendDeltaTimeOp(list, ws_logs) {
  if (list.length) {
    var entry = list.pop();
    window.setTimeout(function() {
      if (ws.readyState == WebSocket.OPEN) {
        ws.send(entry.op);
        sendDeltaTimeOp(list);
      } else {
        appendMsg(ws_logs, "WebSocket connection error");
      }
    }, entry.delta);
  }
}

function bindSendMessage(ws_logs) {
  $('#send').unbind();

  $('#send').click(function() {
    var message = $('#message').val();
    if (message && ws.readyState == WebSocket.OPEN) {
      ws.send(message);
    } else if (ws.readyState == WebSocket.OPEN) {
      appendMsg(ws_logs, "Missing argument(s)");
    } else {
      appendMsg(ws_logs, "WebSocket connection error");
    }
  });
}

function startWS()
{
  $('#start_ws').hide();

  var ws_logs = $('#ws_logs');
  ws_logs.empty();

  if ("WebSocket" in window) {
    ws = new WebSocket("ws://" + window.location.host + "/sub");

    appendMsg(ws_logs, "Opening WebSocket Connection...");

    ws.onopen = function () {
      appendMsg(ws_logs, "Opened WebSocket Connection.");

      // Show application interface
      $('#if').show();
      bindOps(ws_logs);
      bindSendMessage(ws_logs);
    };

    ws.onmessage = function(event) {
      var msg = event.data;
      appendMsg(ws_logs, msg);
    };

    ws.onclose = function() {
      appendMsg(ws_logs, "Closed WebSocket Connection");
      $('#if').hide();
      $('#start_ws').show();
    };

  } else {
    appendMsg(ws_logs, "Your browser does not support WebSocket");
  }
}

</script>
</head>

<body>
<h1>WebSocket Graph Server</h1>
<div id="ws">
  <button id="start_ws" onclick="startWS()">Start connection</button>

  <div id='if' style="display:none">
  <button id="close">Close connection</button>

  <h3>Insert Edge</h3>
  <label for="insert_i">Vertex 1:</label>
  <input id="insert_i" type="text"/>
  <label for="insert_j">Vertex 2:</label>
  <input id="insert_j" type="text"/><br>
  <label for="insert_w">Weight:</label>
  <input id="insert_w" type="text"/>
  <button id="insert">Insert</button>

  <h3>Delete Edge</h3>
  <label for="delete_i">Vertex 1:</label>
  <input id="delete_i" type="text"/>
  <label for="delete_j">Vertex 2:</label>
  <input id="delete_j" type="text"/>
  <button id="delete">Delete</button>

  <h3>Find Edge</h3>
  <label for="find_i">Vertex 1:</label>
  <input id="find_i" type="text"/>
  <label for="find_j">Vertex 2:</label>
  <input id="find_j" type="text"/>
  <button id="find">Find</button>

  <h3>Range Find</h3>
  <label for="range_i1">Vertex 1 Range:</label>
  <input id="range_i1" type="text"/>~
  <input id="range_i2" type="text"/><br>
  <label for="range_j1">Vertex 2 Range:</label>
  <input id="range_j1" type="text"/>~
  <input id="range_j2" type="text"/>
  <button id="range">Find</button>

  <!--
  <label for="file">Load file</label>
  <input id="file" type="file" name="file"/>
  <br>
  
  <label for="message">Message</label>
  <input id="message" type="text"/>
  <input id="send" type="submit" value="Send"/>
  //-->

  <br>
  <br>
  <div class="scroll_list">
  <ul id="ws_logs">
  </ul>
  </div>
  </div>

</div>
</body>
</html>
